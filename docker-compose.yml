services:
  # PostgreSQL Database - Used by CMS only (Data Gateway pattern)
  postgres:
    image: postgres:16-alpine
    container_name: manteq-postgres
    hostname: postgres
    environment:
      - POSTGRES_DB=cms_database
      - POSTGRES_USER=cms_user
      - POSTGRES_PASSWORD=ManteqCMS@2025
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - manteq-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cms_user -d cms_database"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # CMS - Content Management System (Data Gateway)
  cms-api:
    build:
      context: .
      dockerfile: CMS.Webapi/Dockerfile
    container_name: manteq-cms-api
    hostname: cms-api
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5000
      - ConnectionStrings__DefaultConnection=Host=postgres;Port=5432;Database=cms_database;Username=cms_user;Password=ManteqCMS@2025
      - FileStorage__Path=/app/storage/CmsDocuments
    ports:
      - "5000:5000"
    volumes:
      - cms-storage:/app/storage
    networks:
      - manteq-network
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5000/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # TMS - Template Management System (Stateless)
  tms-api:
    build:
      context: .
      dockerfile: TMS.WebApi/Dockerfile
    container_name: manteq-tms-api
    hostname: tms-api
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5267
      - CmsApi__BaseUrl=http://cms-api:5000
      - TMS__SharedStoragePath=/app/storage/TmsGenerated
      - TMS__TempUploadPath=/app/storage/TmsTemp
      - TMS__DocumentRetentionHours=0.25
      - TMS__CleanupIntervalMinutes=5
      - TMS__MaxFileSizeMB=100
      - TMS__LibreOfficeTimeout=30000
    ports:
      - "5267:5267"
    volumes:
      - tms-storage:/app/storage
    networks:
      - manteq-network
    depends_on:
      cms-api:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5267/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  # Email Service - Email Automation (Stateless)
  email-service:
    build:
      context: .
      dockerfile: EmailService.WebApi/Dockerfile
    container_name: manteq-email-service
    hostname: email-service
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5030
      - Email__Smtp__Host=${SMTP_HOST:-smtp-mail.outlook.com}
      - Email__Smtp__Port=${SMTP_PORT:-587}
      - Email__Smtp__EnableSsl=${SMTP_ENABLE_SSL:-true}
      - Email__Smtp__Username=${SMTP_USERNAME}
      - Email__Smtp__Password=${SMTP_PASSWORD}
      - TmsApi__BaseUrl=http://tms-api:5267
      - CmsApi__BaseUrl=http://cms-api:5000
    ports:
      - "5030:5030"
    networks:
      - manteq-network
    depends_on:
      tms-api:
        condition: service_healthy
      cms-api:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5030/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

networks:
  manteq-network:
    driver: bridge
    name: manteq-network

volumes:
  postgres-data:
    name: manteq-postgres-data
  cms-storage:
    name: manteq-cms-storage
  tms-storage:
    name: manteq-tms-storage
