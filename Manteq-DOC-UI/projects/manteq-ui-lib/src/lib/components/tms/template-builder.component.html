<!-- Header Section -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h4 class="mb-1">Template Builder</h4>
      <p class="text-muted mb-0">Manage and organize your document templates</p>
    </div>
    <button class="btn btn-primary" (click)="openAddModal()">
      <i class="bi bi-plus-lg me-1"></i> Add New Template
    </button>
  </div>

  <!-- Search and Filters -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-6">
          <div class="input-group">
            <span class="input-group-text bg-white">
              <i class="bi bi-search"></i>
            </span>
            <input 
              type="text" 
              class="form-control border-start-0" 
              [(ngModel)]="searchTerm"
              (keyup.enter)="searchTemplates()"
              placeholder="Search templates...">
          </div>
        </div>
        <div class="col-md-3">
          <select class="form-select" (change)="filterByType($any($event.target).value)">
            <option value="">All Types</option>
            <option value="Report">Report</option>
            <option value="Invoice">Invoice</option>
            <option value="Contract">Contract</option>
            <option value="Letter">Letter</option>
          </select>
        </div>
        <div class="col-md-3">
          <select class="form-select" (change)="filterTemplates($any($event.target).value)">
            <option value="all">All Status</option>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
            <option value="draft">Draft</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Templates Table -->
  <div class="card">
    <div class="card-body p-0">
      @if (loading()) {
        <div class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      } @else if (filteredTemplates().length === 0) {
        <div class="text-center py-5 text-muted">
          <i class="bi bi-inbox display-4"></i>
          <p class="mt-3">No templates found</p>
        </div>
      } @else {
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>TEMPLATE NAME</th>
                <th>TEMPLATE TYPE</th>
                <th>OUTPUT FORMAT</th>
                <th>STATUS</th>
                <th>LAST UPDATED</th>
                <th class="text-end">ACTIONS</th>
              </tr>
            </thead>
            <tbody>
              @for (template of paginatedTemplates(); track template.id) {
                <tr>
                  <td>
                    <div>
                      <div class="fw-medium">{{ template.name }}</div>
                      @if (template.description) {
                        <small class="text-muted">{{ template.description }}</small>
                      }
                    </div>
                  </td>
                  <td>
                    <span [class]="getTypeBadgeClass(template.category)">
                      {{ template.category }}
                    </span>
                  </td>
                  <td>
                    @if (template.cmsDocumentId) {
                      <span class="text-muted">PDF, DOCX</span>
                    } @else {
                      <span class="text-muted">—</span>
                    }
                  </td>
                  <td>
                    <span [class]="getStatusBadgeClass(template)">
                      {{ getStatusText(template) }}
                    </span>
                  </td>
                  <td>{{ template.updatedAt | dateFormat }}</td>
                  <td class="text-end">
                    <div class="action-buttons">
                      <!-- Download Template -->
                      <button 
                        class="action-btn action-btn-primary" 
                        (click)="downloadTemplate(template)"
                        title="Download Template File">
                        <i class="bi bi-cloud-download"></i>
                      </button>
                      <!-- Download Placeholders Excel -->
                      <button 
                        class="action-btn action-btn-success" 
                        (click)="downloadPlaceholdersExcel(template)"
                        title="Download Placeholders Excel">
                        <i class="bi bi-file-earmark-spreadsheet"></i>
                      </button>
                      <!-- Toggle Active/Inactive -->
                      <button 
                        [class]="template.isActive ? 'action-btn action-btn-warning' : 'action-btn action-btn-secondary'" 
                        (click)="toggleTemplateStatus(template)"
                        [title]="template.isActive ? 'Deactivate Template' : 'Activate Template'">
                        <i [class]="template.isActive ? 'bi bi-toggle2-on' : 'bi bi-toggle2-off'"></i>
                      </button>
                      <!-- Move to Trash -->
                      <button 
                        class="action-btn action-btn-danger" 
                        (click)="deleteTemplate(template)"
                        title="Move to Trash">
                        <i class="bi bi-trash3"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }
    </div>
    @if (!loading() && filteredTemplates().length > 0) {
      <div class="card-footer bg-white">
        <div class="d-flex justify-content-between align-items-center">
          <small class="text-muted">Showing {{ (currentPage() - 1) * itemsPerPage() + 1 }} to {{ Math.min(currentPage() * itemsPerPage(), filteredTemplates().length) }} of {{ filteredTemplates().length }} results</small>
          @if (totalPages() > 1) {
            <nav>
              <ul class="pagination pagination-sm mb-0">
                <li [class.disabled]="currentPage() === 1" class="page-item">
                  <button class="page-link" (click)="previousPage()" [disabled]="currentPage() === 1">
                    <i class="bi bi-chevron-left"></i>
                  </button>
                </li>
                @for (page of pages(); track page) {
                  <li [class.active]="currentPage() === page" class="page-item">
                    <button class="page-link" (click)="goToPage(page)">{{ page }}</button>
                  </li>
                }
                <li [class.disabled]="currentPage() === totalPages()" class="page-item">
                  <button class="page-link" (click)="nextPage()" [disabled]="currentPage() === totalPages()">
                    <i class="bi bi-chevron-right"></i>
                  </button>
                </li>
              </ul>
            </nav>
          }
        </div>
      </div>
    }
  </div>

<!-- Add Template Modal -->
@if (showAddModal()) {
  <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-light border-0">
          <div>
            <h5 class="modal-title mb-1">
              <i class="bi bi-plus-circle-fill text-primary me-2"></i>
              Add New Template
            </h5>
            <p class="text-muted small mb-0">Upload and configure your document template</p>
          </div>
          <button type="button" class="btn-close" (click)="closeAddModal()"></button>
        </div>
        <div class="modal-body p-4">
          <div class="row g-4">
            <!-- Left Column: Form -->
            <div class="col-lg-8">
              <!-- Template Details Section -->
              <div class="card border-0 shadow-sm mb-3">
                <div class="card-header bg-primary bg-opacity-10 border-0">
                  <h6 class="mb-0 text-primary">
                    <i class="bi bi-file-text me-2"></i>
                    Template Details
                  </h6>
                </div>
                <div class="card-body">
                  <div class="row g-3">
                    <div class="col-md-8">
                      <label class="form-label fw-semibold">
                        Template Name <span class="text-danger">*</span>
                      </label>
                      <input 
                        type="text" 
                        class="form-control" 
                        [(ngModel)]="uploadForm.name"
                        placeholder="Enter template name">
                    </div>

                    <div class="col-md-4">
                      <label class="form-label fw-semibold">
                        Template Type <span class="text-danger">*</span>
                      </label>
                      <select 
                        class="form-select" 
                        [(ngModel)]="uploadForm.type">
                        <option value="">Select type</option>
                        <option value="QuotationReport">Quotation Report</option>
                        <option value="TOB">TOB</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Upload Section -->
              <div class="card border-0 shadow-sm mb-3">
                <div class="card-header bg-success bg-opacity-10 border-0">
                  <h6 class="mb-0 text-success">
                    <i class="bi bi-cloud-upload me-2"></i>
                    Upload Template File
                  </h6>
                </div>
                <div class="card-body">
                  <label class="form-label fw-semibold">
                    Template File <span class="text-danger">*</span>
                    <i class="bi bi-info-circle text-muted ms-1" title="Only .docx and .xlsx files"></i>
                  </label>
                  <div class="upload-area border-2 rounded p-4 text-center position-relative">
                    @if (!selectedFile()) {
                      <div class="upload-placeholder">
                        <i class="bi bi-cloud-arrow-up display-3 text-primary mb-3"></i>
                        <h6 class="text-dark mb-2">Drag and drop your file here</h6>
                        <p class="text-muted small mb-3">or click to browse</p>
                        <span class="badge bg-light text-dark">Supports .docx and .xlsx files</span>
                      </div>
                    } @else {
                      <div class="file-selected">
                        <i class="bi bi-file-earmark-check display-3 text-success mb-3"></i>
                        <h6 class="text-success mb-1">{{ selectedFile()!.name }}</h6>
                        <p class="text-muted small mb-0">{{ (selectedFile()!.size / 1024).toFixed(2) }} KB</p>
                      </div>
                    }
                    <input 
                      type="file" 
                      class="form-control position-absolute top-0 start-0 w-100 h-100 opacity-0" 
                      style="cursor: pointer;"
                      (change)="onFileSelected($event)"
                      accept=".docx,.xlsx,.doc,.xls">
                  </div>

                  <div class="mt-3">
                    <label class="form-label fw-semibold">Output Format</label>
                    <div class="btn-group w-100" role="group">
                      <input type="radio" class="btn-check" name="outputFormat" id="pdf" 
                             [(ngModel)]="uploadForm.outputFormat" value="PDF" checked>
                      <label class="btn btn-outline-primary" for="pdf">
                        <i class="bi bi-file-pdf me-1"></i> PDF
                      </label>
                      
                      <input type="radio" class="btn-check" name="outputFormat" id="docx" 
                             [(ngModel)]="uploadForm.outputFormat" value="DOCX">
                      <label class="btn btn-outline-primary" for="docx">
                        <i class="bi bi-file-word me-1"></i> DOCX
                      </label>
                      
                      <input type="radio" class="btn-check" name="outputFormat" id="excel" 
                             [(ngModel)]="uploadForm.outputFormat" value="Excel">
                      <label class="btn btn-outline-primary" for="excel">
                        <i class="bi bi-file-excel me-1"></i> Excel
                      </label>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Test Template Section -->
              <div class="card border-0 shadow-sm border-warning">
                <div class="card-header bg-warning bg-opacity-10 border-0">
                  <h6 class="mb-0 text-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Test Template (Optional)
                  </h6>
                </div>
                <div class="card-body">
                  <p class="small text-muted mb-3">
                    <i class="bi bi-info-circle me-1"></i>
                    Upload test data to preview how your template will render with actual values.
                  </p>
                  
                  <div class="alert alert-info border-info mb-3">
                    <div class="d-flex align-items-center">
                      <i class="bi bi-download fs-4 me-3 text-info"></i>
                      <div class="flex-grow-1">
                        <strong class="d-block mb-1">Step 1: Download Placeholder Excel</strong>
                        <small>First, download the placeholder Excel file with default values from your selected template.</small>
                      </div>
                    </div>
                    <button 
                      class="btn btn-info btn-sm mt-2 w-100" 
                      (click)="downloadPlaceholderForTest()"
                      [disabled]="!selectedFile()">
                      <i class="bi bi-download me-1"></i> Download Placeholder Excel
                    </button>
                  </div>

                  <div class="alert alert-warning border-warning mb-3">
                    <div class="d-flex align-items-center">
                      <i class="bi bi-pencil-square fs-4 me-3 text-warning"></i>
                      <div class="flex-grow-1">
                        <strong class="d-block mb-1">Step 2: Fill Test Data</strong>
                        <small>Open the downloaded Excel, fill in test values, then upload it below to test your template.</small>
                      </div>
                    </div>
                  </div>

                  <div class="row g-2">
                    <div class="col-8">
                      <label class="form-label small">Upload Filled Excel</label>
                      <input 
                        type="file" 
                        class="form-control form-control-sm" 
                        (change)="onTestFileSelected($event)"
                        accept=".xlsx"
                        placeholder="Choose test Excel file">
                      @if (testFile()) {
                        <small class="text-success mt-1 d-block">
                          <i class="bi bi-check-circle me-1"></i>
                          {{ testFile()!.name }}
                        </small>
                      }
                    </div>
                    <div class="col-4">
                      <label class="form-label small">&nbsp;</label>
                      <button 
                        class="btn btn-warning btn-sm w-100" 
                        (click)="testTemplate()"
                        [disabled]="!testFile()">
                        <i class="bi bi-play-fill me-1"></i> Test Template
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Right Column: Guidelines -->
            <div class="col-lg-4">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-warning bg-opacity-10 border-0">
                  <h6 class="mb-0 text-warning">
                    <i class="bi bi-lightbulb-fill me-2"></i>
                    Guidelines
                  </h6>
                </div>
                <div class="card-body">
                  <div class="guideline-section mb-4">
                    <div class="d-flex align-items-start mb-2">
                      <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                      <strong class="text-dark">Template Creation</strong>
                    </div>
                    <ul class="small text-muted ps-4 mb-0">
                      <li class="mb-2">Upload .docx or .xlsx files only</li>
                      <li class="mb-2">Keep formatting consistent</li>
                      <li>(fonts, spacing, alignment, layout, images)</li>
                    </ul>
                  </div>

                  <div class="guideline-section mb-4">
                    <div class="d-flex align-items-start mb-2">
                      <i class="bi bi-stars text-warning me-2 mt-1"></i>
                      <strong class="text-dark">Adding Dynamic Variables</strong>
                    </div>
                    <ol class="small text-muted ps-4 mb-0">
                      <li class="mb-2">Open template in Word/Excel</li>
                      <li class="mb-2">Go to File → Info → Properties → Advanced Properties → Custom</li>
                      <li class="mb-2">
                        Add a new property:
                        <div class="mt-2 p-2 bg-light rounded">
                          <strong>Name:</strong> <code>variable_name</code><br>
                          <strong>Type:</strong> Text<br>
                          <strong>Value:</strong> Default value
                        </div>
                      </li>
                    </ol>
                  </div>

                  <div class="guideline-section">
                    <div class="d-flex align-items-start mb-2">
                      <i class="bi bi-file-earmark-text-fill text-info me-2 mt-1"></i>
                      <strong class="text-dark">Embedding Templates</strong>
                    </div>
                    <p class="small text-muted mb-2">
                      Include another saved template inside your main template:
                    </p>
                    <div class="p-2 bg-light rounded">
                      <code class="text-danger">&lt;&lt;include_TemplateName&gt;&gt;</code>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer border-0 bg-light">
          <div class="d-flex justify-content-between w-100 align-items-center">
            <small class="text-muted">
              <i class="bi bi-info-circle me-1"></i>
              Template Version: 1.0 | Status: Draft
            </small>
            <div class="btn-group">
              <button type="button" class="btn btn-secondary" (click)="closeAddModal()">
                <i class="bi bi-x-lg me-1"></i> Cancel
              </button>
              <button 
                type="button" 
                class="btn btn-primary" 
                (click)="uploadTemplate()"
                [disabled]="!selectedFile() || !uploadForm.name || !uploadForm.type">
                <i class="bi bi-save me-1"></i> Save Template
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
}
